<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的行程</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f8fafc; }
        .order-card { transition: all 0.3s ease; }
    </style>
</head>
<body class="pb-24">

    <header class="p-6 bg-white sticky top-0 z-40 border-b">
        <h1 class="text-2xl font-black text-slate-800">我的行程</h1>
        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mt-1">核銷與扣款系統</p>
    </header>

    <main id="order-list" class="p-6 space-y-4"></main>

    <div id="otp-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-[2.5rem] p-8 shadow-2xl text-center">
            <div class="w-16 h-16 bg-rose-50 text-rose-500 rounded-3xl flex items-center justify-center mx-auto mb-4">
                <i data-lucide="store" class="w-8 h-8"></i>
            </div>
            <h3 class="font-bold text-lg text-slate-800">請店家輸入代碼</h3>
            <p id="otp-hint" class="text-[10px] text-gray-400 mt-2 mb-6 font-bold uppercase tracking-tighter"></p>
            
            <input type="tel" id="otp-input" maxlength="4" placeholder="0000" class="w-full text-center text-3xl tracking-[0.5em] font-black p-4 bg-gray-50 rounded-2xl mb-6 outline-none focus:ring-2 focus:ring-rose-400 border-none">
            
            <div class="flex gap-3">
                <button onclick="closeOTP()" class="flex-1 py-3 text-sm font-bold text-gray-400">取消</button>
                <button onclick="confirmVerify()" class="flex-1 py-3 bg-slate-900 text-white rounded-xl text-sm font-bold shadow-lg">確認核銷</button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 z-50">
        <a href="index.html" class="text-gray-300 flex flex-col items-center"><i data-lucide="home" class="w-5 h-5"></i><span class="text-[10px] mt-1 font-bold">探索</span></a>
        <a href="orders.html" class="text-rose-500 flex flex-col items-center"><i data-lucide="calendar" class="w-5 h-5"></i><span class="text-[10px] mt-1 font-bold">行程</span></a>
        <a href="profile.html" class="text-gray-300 flex flex-col items-center"><i data-lucide="user" class="w-5 h-5"></i><span class="text-[10px] mt-1 font-bold">我的</span></a>
        <a href="admin.html" class="text-gray-300 flex flex-col items-center"><i data-lucide="settings" class="w-5 h-5"></i><span class="text-[10px] mt-1 font-bold">管理</span></a>
    </nav>

    <script>
        let currentOrderIndex = null;

        function renderOrders() {
            const orders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            const list = document.getElementById('order-list');
            
            if (orders.length === 0) {
                list.innerHTML = `<div class="text-center py-20 text-gray-300"><p>尚無行程</p></div>`;
            } else {
                list.innerHTML = orders.map((order, index) => `
                    <div class="order-card bg-white rounded-[2rem] p-5 shadow-sm border border-gray-50">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <span class="text-[9px] font-black bg-slate-100 text-slate-500 px-2 py-1 rounded">SHOP ID: ${order.shopId}</span>
                                <h3 class="font-bold text-slate-800 mt-2">${order.shop}</h3>
                                <p class="text-xs text-gray-400">${order.service}</p>
                            </div>
                            <p class="font-black text-slate-800">$${order.price}</p>
                        </div>
                        ${order.status === '待核銷' ? `
                            <button onclick="openOTP(${index})" class="w-full py-3 bg-rose-500 text-white rounded-xl text-xs font-bold shadow-md">店家現場核銷</button>
                        ` : `
                            <div class="flex items-center justify-center gap-2 py-3 bg-emerald-50 text-emerald-500 rounded-xl text-xs font-bold">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> 已完成支付
                            </div>
                        `}
                    </div>
                `).join('');
            }
            lucide.createIcons();
        }

        function openOTP(index) {
            currentOrderIndex = index;
            const orders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            document.getElementById('otp-hint').innerText = `請輸入店家 ${orders[index].shop} 的 4 位數代碼`;
            document.getElementById('otp-modal').classList.remove('hidden');
        }

        function closeOTP() {
            document.getElementById('otp-modal').classList.add('hidden');
            document.getElementById('otp-input').value = '';
        }

        function confirmVerify() {
            const inputOtp = document.getElementById('otp-input').value;
            const orders = JSON.parse(localStorage.getItem('my_orders') || '[]');
            const order = orders[currentOrderIndex];
            let userBal = parseInt(localStorage.getItem('user_bal') || '0');

            // 驗證店家代碼
            if (inputOtp === order.shopId || (inputOtp === "000"+order.shopId.slice(-1))) { 
                if (userBal >= order.price) {
                    // 1. 消費者端全額扣款
                    userBal -= order.price;
                    localStorage.setItem('user_bal', userBal);

                    // 2. 後台自動分帳 (80/20)
                    const shopShare = Math.floor(order.price * 0.8);
                    const platformShare = order.price - shopShare;

                    // 店家拿到 80%
                    let shopVault = JSON.parse(localStorage.getItem('shop_vault') || '{}');
                    shopVault[order.shopId] = (shopVault[order.shopId] || 0) + shopShare;
                    localStorage.setItem('shop_vault', JSON.stringify(shopVault));

                    // 平台拿到 20%
                    let platformVault = parseFloat(localStorage.getItem('platform_vault') || '0');
                    platformVault += platformShare;
                    localStorage.setItem('platform_vault', platformVault.toString());

                    // 3. 更新訂單狀態為已完工
                    order.status = "已完工";
                    localStorage.setItem('my_orders', JSON.stringify(orders));

                    // 4. 寫入消費紀錄 (顯示給客戶看的是全額)
                    let history = JSON.parse(localStorage.getItem('pay_history') || '[]');
                    history.unshift({
                        name: `支付給 ${order.shop}`,
                        amount: order.price,
                        type: "minus",
                        date: new Date().toLocaleDateString()
                    });
                    localStorage.setItem('pay_history', JSON.stringify(history));

                    // 5. 提示訊息 (僅告知核銷成功與扣款全額)
                    alert(`✅ 核銷成功！\n您已完成支付 $${order.price}。`);
                    
                    closeOTP();
                    renderOrders();
                } else {
                    alert("錢包餘額不足，請先至個人頁面儲值。");
                }
            } else {
                alert("店家驗證碼錯誤，核銷失敗。");
            }
        }

        window.onload = renderOrders;
    </script>
</body>
</html>

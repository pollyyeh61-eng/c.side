<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美業入口平台 | 商家與客戶雙端系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .page { display: none; }
        .page.active { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #map { width: 100%; height: 250px; border-radius: 20px; margin-top: 10px; }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <div id="page-home" class="page active">
        <header class="bg-white p-4 sticky top-0 z-50 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <div class="flex items-center text-rose-500 cursor-pointer" onclick="toggleMapView()">
                    <i data-lucide="map" class="w-5 h-5 mr-1"></i>
                    <span id="map-btn-text" class="font-bold text-sm">開啟地圖搜尋</span>
                </div>
                <h1 class="text-sm font-black text-gray-800 tracking-tighter">美業入口平台</h1>
            </div>
            <div class="relative">
                <input type="text" placeholder="搜尋：美髮、美甲、SPA..." class="w-full bg-gray-100 rounded-full py-2 px-10 focus:outline-none focus:ring-2 focus:ring-rose-300">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-5 h-5 text-gray-400"></i>
            </div>
        </header>
        <section id="map-container" class="px-4 hidden"><div id="map"></div></section>
        <section class="p-4 flex gap-6 overflow-x-auto no-scrollbar bg-white">
            <div class="flex flex-col items-center min-w-[60px]"><div class="w-12 h-12 bg-rose-100 rounded-2xl flex items-center justify-center text-rose-500 mb-1 shadow-sm"><i data-lucide="scissors"></i></div><span class="text-[10px]">美髮</span></div>
            <div class="flex flex-col items-center min-w-[60px]"><div class="w-12 h-12 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-500 mb-1 shadow-sm"><i data-lucide="sparkles"></i></div><span class="text-[10px]">美甲</span></div>
            <div class="flex flex-col items-center min-w-[60px]"><div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-500 mb-1 shadow-sm"><i data-lucide="waves"></i></div><span class="text-[10px]">SPA</span></div>
        </section>
        <main class="p-4 space-y-4" id="shop-list-container"></main>
    </div>

    <div id="page-orders" class="page">
        <header class="bg-white p-4 border-b font-bold text-center">我的預約行程</header>
        <div id="order-list" class="p-4 space-y-4 text-center py-20 text-gray-400">登入後即可查看行程</div>
    </div>

    <div id="page-profile" class="page">
        <div class="bg-rose-500 p-8 text-white rounded-b-[40px]">
            <h2 id="display-phone" class="font-bold text-xl mb-4">訪客登入</h2>
            <div class="bg-white/10 backdrop-blur rounded-2xl p-4 flex justify-between items-center">
                <div><p class="text-[10px] opacity-70">儲值金餘額</p><p id="display-balance" class="text-2xl font-black">$ 0</p></div>
                <button onclick="simulateTopUp()" class="bg-white text-rose-500 px-4 py-2 rounded-xl text-sm font-bold">儲值</button>
            </div>
        </div>
        <div class="p-6 space-y-4">
            <button onclick="phoneLogin()" id="login-btn" class="w-full bg-slate-800 text-white py-4 rounded-2xl font-bold">手機註冊/登入</button>
            <button onclick="navigateTo('page-admin-login')" class="w-full border-2 border-slate-200 text-slate-500 py-4 rounded-2xl font-bold italic">我是店家主，登入管理後台</button>
        </div>
    </div>

    <div id="page-admin-login" class="page">
        <div class="p-10 text-center">
            <h2 class="text-2xl font-black text-slate-800 mb-2">店家管理登入</h2>
            <p class="text-gray-400 text-sm mb-8">請輸入您的店家代碼進入管理模式</p>
            <input type="password" id="admin-code" placeholder="請輸入代碼 (如: 001)" class="w-full border-b-2 border-slate-200 p-4 text-center text-2xl tracking-widest outline-none focus:border-rose-500 transition">
            <button onclick="handleAdminLogin()" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-bold mt-8">進入門面管理</button>
        </div>
    </div>

    <div id="page-admin-dashboard" class="page bg-slate-100 min-h-screen pb-20">
        <header class="bg-white p-4 flex justify-between items-center shadow-sm">
            <span id="current-admin-shop" class="font-bold text-rose-500">店家名稱</span>
            <button onclick="navigateTo('page-home')" class="text-xs bg-slate-100 px-3 py-1 rounded-full">切換回客端</button>
        </header>
        <div class="p-4 space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-sm">
                <h3 class="font-bold mb-4">門面資訊編輯</h3>
                <div class="space-y-4">
                    <input type="text" id="edit-shop-name" placeholder="更改店名" class="w-full p-3 bg-gray-50 rounded-xl border">
                    <textarea id="edit-shop-desc" placeholder="店家簡介" class="w-full p-3 bg-gray-50 rounded-xl border"></textarea>
                    <button onclick="saveShopInfo()" class="w-full bg-emerald-500 text-white py-3 rounded-xl font-bold">儲存並發佈</button>
                </div>
            </div>
            <div class="bg-white p-6 rounded-3xl shadow-sm">
                <h3 class="font-bold mb-4 italic">今日預約管理</h3>
                <div id="admin-order-list" class="text-xs text-gray-400">目前尚無預約...</div>
            </div>
        </div>
    </div>

    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around py-3 z-50">
        <button onclick="navigateTo('page-home')" class="nav-item text-rose-500" data-target="page-home"><i data-lucide="home" class="w-6 h-6"></i><span class="text-[10px] block">探索</span></button>
        <button onclick="navigateTo('page-orders')" class="nav-item text-gray-400" data-target="page-orders"><i data-lucide="calendar" class="w-6 h-6"></i><span class="text-[10px] block">行程</span></button>
        <button onclick="navigateTo('page-profile')" class="nav-item text-gray-400" data-target="page-profile"><i data-lucide="user" class="w-6 h-6"></i><span class="text-[10px] block">我的</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
            authDomain: "holyhairsalon-f73bf.firebaseapp.com",
            databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
            projectId: "holyhairsalon-f73bf",
            storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
            messagingSenderId: "960169055224",
            appId: "1:960169055224:web:2c826e76e3a177fcbf3c0d",
            measurementId: "G-ZRY4YH5Q63"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        lucide.createIcons();

        // 頁面控制
        window.navigateTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('bottom-nav').style.display = (id.includes('admin')) ? 'none' : 'flex';
        };

        // 店家代碼對照表 (分權核心)
        const adminMap = { "001": "A店髮藝", "002": "B店美甲", "003": "C店SPA" };
        window.handleAdminLogin = () => {
            const code = document.getElementById('admin-code').value;
            if (adminMap[code]) {
                alert(`歡迎進入 ${adminMap[code]} 管理系統`);
                document.getElementById('current-admin-shop').innerText = adminMap[code];
                document.getElementById('edit-shop-name').value = adminMap[code];
                navigateTo('page-admin-dashboard');
            } else { alert("錯誤的店家代碼！"); }
        };

        // 地圖切換
        let map;
        window.toggleMapView = () => {
            const container = document.getElementById('map-container');
            if(container.classList.toggle('hidden')) return;
            if(!map) map = new google.maps.Map(document.getElementById("map"), { zoom: 15, center: {lat: 25.03, lng: 121.56}, disableDefaultUI: true });
        };

        // 用戶儲值與行程讀取
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('display-phone').innerText = user.phoneNumber;
                // 儲值金同步
                const uRef = doc(db, "users", user.uid);
                onSnapshot(uRef, (s) => document.getElementById('display-balance').innerText = `$ ${s.data()?.balance || 0}`);
                // 行程頁同步
                const q = query(collection(db, "bookings"), where("userId", "==", user.uid));
                onSnapshot(q, (sn) => {
                    const list = document.getElementById('order-list');
                    if(sn.empty) { list.innerText = "暫無行程"; return; }
                    list.innerHTML = sn.docs.map(d => `<div class="bg-white p-4 rounded-xl shadow-sm text-left"><b>${d.data().shopName}</b><p class="text-xs">${d.data().date}</p></div>`).join('');
                });
            }
        });

        // 初始化客端店家列表
        document.getElementById('shop-list-container').innerHTML = Object.values(adminMap).map(name => `
            <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm">
                <div><h3 class="font-bold text-gray-800">${name}</h3><p class="text-[10px] text-gray-400">目前可預約時段：10:00 - 18:00</p></div>
                <button class="bg-rose-500 text-white text-xs px-4 py-2 rounded-lg font-bold">進入預約</button>
            </div>
        `).join('');
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initMap" async defer></script>
</body>
</html>

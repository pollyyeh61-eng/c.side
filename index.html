<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美業入口平台 | 你的美感生活</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f9fafb; }
        .page { display: none; }
        .page.active { display: block; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fab-btn { box-shadow: 0 15px 30px -5px rgba(244, 63, 94, 0.4); }
        .input-focus:focus { ring: 2px; ring-color: #fb7185; outline: none; }
    </style>
</head>
<body class="pb-24">

    <div id="page-home" class="page active">
        <header class="bg-white p-6 sticky top-0 z-50 border-b">
            <h1 class="text-rose-500 font-black text-xl italic mb-4">BEAUTY LIFE</h1>
            <div class="relative">
                <input type="text" placeholder="搜尋 10 家精選美感服務..." class="w-full bg-gray-100 rounded-2xl py-3 px-12 text-sm outline-none">
                <i data-lucide="search" class="absolute left-4 top-3.5 w-4 h-4 text-gray-400"></i>
            </div>
        </header>
        <main class="p-6 space-y-5" id="shop-list-container"></main>
    </div>

    <div id="page-orders" class="page">
        <header class="p-6 bg-white border-b font-black text-xl">我的行程</header>
        <div class="p-6 space-y-4" id="order-list"></div>
        <div id="modal-order" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-6">
            <div class="bg-white w-full rounded-[3rem] p-8 space-y-4">
                <h3 class="text-xl font-bold text-gray-800">預約明細</h3>
                <div class="space-y-2 border-y py-4">
                    <p class="text-xs text-gray-400">店家：<span id="m-shop" class="text-gray-800 font-bold ml-2"></span></p>
                    <p class="text-xs text-gray-400">代碼：<span id="m-code" class="text-rose-500 font-bold ml-2"></span></p>
                </div>
                <button onclick="closeModal()" class="w-full bg-gray-100 py-3 rounded-2xl font-bold">關閉</button>
            </div>
        </div>
    </div>

    <div id="page-profile" class="page">
        <div id="auth-section" class="p-8 mt-10">
            <h2 class="text-3xl font-black mb-8">開始體驗<br><span class="text-rose-500">美感生活</span></h2>
            <input type="tel" id="user-phone" placeholder="輸入手機號碼" class="w-full p-4 rounded-2xl bg-white shadow-sm mb-4 outline-none border-none">
            <button onclick="handleLogin()" class="w-full bg-rose-500 text-white py-4 rounded-2xl font-bold shadow-lg">快速註冊 / 登入</button>
        </div>
        <div id="user-section" class="hidden">
            <div class="bg-rose-500 p-10 pt-16 text-white rounded-b-[3rem] shadow-lg">
                <div class="flex items-center gap-4">
                    <div class="w-16 h-16 bg-white rounded-3xl flex items-center justify-center text-rose-500 shadow-xl"><i data-lucide="user" class="w-8 h-8"></i></div>
                    <div><h2 id="display-phone" class="font-black text-xl">0912-***-456</h2><p class="text-xs opacity-70">黃金會員</p></div>
                </div>
                <div class="mt-8 grid grid-cols-2 gap-4">
                    <div class="bg-white/20 p-4 rounded-2xl backdrop-blur-md"><p class="text-[10px] opacity-80 mb-1">錢包餘額</p><p id="wallet-balance" class="text-2xl font-black">$ 0</p></div>
                    <button onclick="addCredit()" class="bg-white text-rose-500 p-4 rounded-2xl font-bold text-center">線上儲值</button>
                </div>
            </div>
        </div>
    </div>

    <div id="page-admin" class="page bg-slate-50 min-h-screen">
        <header class="p-6 bg-white border-b flex justify-between items-center sticky top-0 z-50">
            <h2 class="font-black text-xl tracking-tighter italic">MANAGER CENTER</h2>
            <span id="admin-status" class="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-400 font-bold uppercase">Disconnected</span>
        </header>

        <div id="admin-login-box" class="p-10 text-center">
            <p class="text-xs text-gray-400 mb-6 font-bold">請輸入管理代碼 (0000 或 001~010)</p>
            <input type="password" id="admin-code-input" placeholder="••••" class="w-32 text-center text-3xl p-4 bg-white rounded-3xl border-none shadow-inner mb-8 focus:ring-2 focus:ring-rose-400">
            <button onclick="handleAdminAuth()" class="w-full bg-slate-900 text-white py-4 rounded-3xl font-bold shadow-xl">進入管理後台</button>
        </div>

        <div id="admin-editor-box" class="hidden p-4 space-y-6 pb-32">
            <div id="super-admin-tools" class="hidden bg-white p-5 rounded-[2rem] shadow-sm">
                <label class="text-[10px] font-bold text-gray-400 block mb-2">切換管理店家</label>
                <select id="admin-shop-selector" onchange="switchAdminShop(this.value)" class="w-full p-2 bg-gray-50 rounded-xl text-sm border-none"></select>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm space-y-3">
                <h3 class="font-bold text-xs text-gray-400 flex justify-between">
                    照片管理 (最多五張) <span class="text-emerald-500">Auto-Saving...</span>
                </h3>
                <div id="photo-inputs" class="space-y-2">
                    <input type="text" data-key="p1" oninput="autoSave(this)" class="photo-input w-full p-2 bg-gray-50 border rounded-xl text-[10px]" placeholder="照片 1 (主圖 URL)">
                    <input type="text" data-key="p2" oninput="autoSave(this)" class="photo-input w-full p-2 bg-gray-50 border rounded-xl text-[10px]" placeholder="照片 2 URL">
                    <input type="text" data-key="p3" oninput="autoSave(this)" class="photo-input w-full p-2 bg-gray-50 border rounded-xl text-[10px]" placeholder="照片 3 URL">
                    <input type="text" data-key="p4" oninput="autoSave(this)" class="photo-input w-full p-2 bg-gray-50 border rounded-xl text-[10px]" placeholder="照片 4 URL">
                    <input type="text" data-key="p5" oninput="autoSave(this)" class="photo-input w-full p-2 bg-gray-50 border rounded-xl text-[10px]" placeholder="照片 5 URL">
                </div>
            </div>

            <div class="bg-white p-6 rounded-[2.5rem] shadow-sm space-y-4">
                <h3 class="font-bold text-xs text-gray-400">詳情內容編輯</h3>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 ml-2">服務介紹</label>
                    <textarea data-key="services" oninput="autoSave(this)" id="adm-services" class="w-full h-24 p-4 bg-gray-50 rounded-2xl text-sm border-none mt-1"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 ml-2">產品介紹</label>
                    <textarea data-key="products" oninput="autoSave(this)" id="adm-products" class="w-full h-24 p-4 bg-gray-50 rounded-2xl text-sm border-none mt-1"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-rose-400 ml-2">套餐介紹</label>
                    <textarea data-key="packages" oninput="autoSave(this)" id="adm-packages" class="w-full h-24 p-4 bg-rose-50 text-rose-500 rounded-2xl text-sm border-none mt-1"></textarea>
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="resetToLocal()" class="flex-1 bg-white border-2 border-slate-200 py-4 rounded-full font-bold text-slate-400 text-sm">還原暫存</button>
                <button onclick="finalPublish()" class="flex-[2] bg-slate-900 text-white py-4 rounded-full font-bold shadow-2xl flex items-center justify-center">
                    <i data-lucide="cloud-upload" class="w-4 h-4 mr-2"></i> 發布至雲端資料庫
                </button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-md border-t flex justify-around py-3 z-[60]">
        <button onclick="navigateTo('page-home')" class="nav-btn text-rose-500 flex flex-col items-center" data-target="page-home"><i data-lucide="home"></i><span class="text-[10px] font-bold">探索</span></button>
        <button onclick="navigateTo('page-orders')" class="nav-btn text-gray-300 flex flex-col items-center" data-target="page-orders"><i data-lucide="calendar"></i><span class="text-[10px] font-bold">行程</span></button>
        <button onclick="navigateTo('page-profile')" class="nav-btn text-gray-300 flex flex-col items-center" data-target="page-profile"><i data-lucide="user"></i><span class="text-[10px] font-bold">我的</span></button>
        <button onclick="navigateTo('page-admin')" class="nav-btn text-gray-300 flex flex-col items-center" data-target="page-admin"><i data-lucide="settings"></i><span class="text-[10px] font-bold">管理</span></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

        const firebaseConfig = { projectId: "holyhairsalon-f73bf" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        lucide.createIcons();

        let activeShopId = '';
        let isSuperAdmin = false;

        // --- 全局導覽 ---
        window.navigateTo = (id) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.toggle('text-rose-500', btn.dataset.target === id);
                btn.classList.toggle('text-gray-300', btn.dataset.target !== id);
            });
        };

        // --- 管理驗證與切換 ---
        window.handleAdminAuth = () => {
            const code = document.getElementById('admin-code-input').value;
            if (code === '0000') {
                isSuperAdmin = true;
                activeShopId = '001';
                setupSuperAdmin();
            } else if (parseInt(code) >= 1 && parseInt(code) <= 10) {
                isSuperAdmin = false;
                activeShopId = code.padStart(3, '0');
            } else {
                return alert("無效的代碼，請輸入 0000 或 001-010");
            }
            enterEditor();
        };

        function setupSuperAdmin() {
            const selector = document.getElementById('admin-shop-selector');
            selector.innerHTML = Array.from({length: 10}, (_, i) => {
                const id = (i + 1).toString().padStart(3, '0');
                return `<option value="${id}">管理店家 ${id}</option>`;
            }).join('');
            document.getElementById('super-admin-tools').classList.remove('hidden');
        }

        window.switchAdminShop = (id) => {
            activeShopId = id;
            loadShopData();
        };

        function enterEditor() {
            document.getElementById('admin-login-box').classList.add('hidden');
            document.getElementById('admin-editor-box').classList.remove('hidden');
            document.getElementById('admin-status').innerText = `Connected: ${activeShopId}`;
            document.getElementById('admin-status').classList.replace('text-slate-400', 'text-emerald-500');
            loadShopData();
        }

        // --- 核心儲存邏輯 (Auto-Save + LocalStorage + Cloud) ---
        window.autoSave = (el) => {
            const key = `temp_${activeShopId}_${el.dataset.key}`;
            localStorage.setItem(key, el.value);
            console.log(`Auto-saved: ${key}`);
        };

        async function loadShopData() {
            // 1. 優先從雲端抓
            const docRef = doc(db, "shops", activeShopId);
            const snap = await getDoc(docRef);
            let data = snap.exists() ? snap.data() : { photos: [], services: '', products: '', packages: '' };

            // 2. 填充欄位 (如果有 localStorage 暫存則提示)
            const fields = ['services', 'products', 'packages'];
            fields.forEach(f => {
                const local = localStorage.getItem(`temp_${activeShopId}_${f}`);
                document.getElementById(`adm-${f}`).value = local || data[f] || '';
            });

            const photoInputs = document.querySelectorAll('.photo-input');
            photoInputs.forEach((input, i) => {
                const local = localStorage.getItem(`temp_${activeShopId}_p${i+1}`);
                input.value = local || (data.photos && data.photos[i]) || '';
            });
        }

        window.finalPublish = async () => {
            const photos = Array.from(document.querySelectorAll('.photo-input')).map(i => i.value);
            const data = {
                photos: photos,
                services: document.getElementById('adm-services').value,
                products: document.getElementById('adm-products').value,
                packages: document.getElementById('adm-packages').value,
                updatedAt: new Date().getTime()
            };

            try {
                await setDoc(doc(db, "shops", activeShopId), data, { merge: true });
                alert(`店家 ${activeShopId} 資料已同步至雲端！暫存已轉為永久儲存。`);
            } catch (e) {
                alert("雲端儲存失敗，請檢查網路。");
            }
        };

        window.resetToLocal = () => {
            if(confirm("確定要放棄目前輸入，還原至上次雲端版本嗎？")) {
                const fields = ['services', 'products', 'packages', 'p1', 'p2', 'p3', 'p4', 'p5'];
                fields.forEach(f => localStorage.removeItem(`temp_${activeShopId}_${f}`));
                loadShopData();
            }
        };

        // --- 基礎功能連動 (維持原本 Login/Balance) ---
        window.handleLogin = () => {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('user-section').classList.remove('hidden');
            document.getElementById('display-phone').innerText = document.getElementById('user-phone').value;
        };
        window.addCredit = () => {
            let b = parseInt(document.getElementById('wallet-balance').innerText.replace('$ ','')) + 1000;
            document.getElementById('wallet-balance').innerText = `$ ${b}`;
        };
    </script>
</body>
</html>
